---
title: "实战复盘：基于 uni-app + 微信云开发的 AI 改善计划小程序 '自升'"
date: "2025-01-20"
summary: "本文记录了开发 '自升' (Self-Ascension) 小程序的技术心路历程。这是一个结合了 DeepSeek AI 模型、uni-app 跨端框架与微信云开发 (Serverless) 的个性化改善计划生成工具。本文将深入探讨开发过程中遇到的环境编译、数据库索引、云函数调试等技术痛点，以及如何构建离线优先的数据同步策略。"
tags: ["uni-app", "微信小程序", "云开发", "AI", "Serverless", "微信云开发"]
category: "tech"
draft: false
---

# 🚀 实战复盘：基于 uni-app + 微信云开发的 AI 改善计划小程序 "自升"

> **摘要**：本文记录了开发 "自升" (Self-Ascension) 小程序的技术心路历程。这是一个结合了 DeepSeek AI 模型、uni-app 跨端框架与微信云开发 (Serverless) 的个性化改善计划生成工具。本文将深入探讨开发过程中遇到的环境编译、数据库索引、云函数调试等技术痛点，以及如何构建离线优先的数据同步策略。

---

## 📅 项目背景

"自升" 旨在通过 AI 为用户生成个性化的 3-30 天心理或习惯改善计划。与普通 Todo 应用不同，它需要处理非结构化的 AI 对话数据，将其转化为结构化的日历任务，并配合微信生态的订阅消息实现全自动触达。

## 🛠️ 第一部分：那些年踩过的坑（技术难点与解决方案）

在 uni-app 与微信云开发的结合过程中，并非一帆风顺。以下是三个最典型的技术挑战：

### 1. 编译环境的“断层”：云函数文件丢失问题
**问题描述**：
在使用 HBuilderX 开发时，我发现每次编译项目，`cloudfunctions` 目录都不会自动同步到微信开发者工具的输出目录（`unpackage/dist/dev/mp-weixin`）。这导致在调试时，开发者工具经常报 "Cloud function root not found" 错误。

**解决方案**：
手动复制显然不是长久之计。我编写了一个自定义的 Node.js 脚本，并将其挂载到 NPM 的 `scripts` 中。
- **脚本逻辑**：递归扫描源码中的云函数目录，自动过滤 `node_modules`，将其完整镜像到编译输出目录。
- **结果**：实现了 `npm run copy-cloudfunctions` 一键同步，打通了 CI/CD 的第一步。

### 2. 云端调试的幽灵错误：Error -604100 & -504002
**问题描述**：
项目初期频繁遇到两个顽固的错误码：
- `-604100 API not found`：通常发生在云函数调用时。
- `-504002 functions execute fail`：云函数执行异常。

**深度排查**：
经过反复排查日志，发现原因主要集中在两点：
1.  **大小写敏感**：云函数在本地文件系统可能不区分大小写，但在云端 Linux 环境下，`login` 和 `Login` 是完全不同的文件夹。
2.  **序列化陷阱**：在使用 `new Date()` 存入云数据库时，由于时区差异和序列化机制，导致服务端时间错乱。

**解决方案**：
- 建立了严格的**部署检查清单**：每次部署前核对文件夹名称与配置代码的一致性。
- **时间标准化**：废弃 JS 原生日期对象，全线统一使用云开发提供的 `db.serverDate()`，利用数据库服务端时间，彻底解决了时区同步问题。

### 3. 数据库索引的“唯一”之惑
**问题描述**：
项目涉及 `Users`（用户）、`Plans`（计划）、`Meditations`（打卡）三张表。初期由于索引设置不当，导致用户无法创建第二个计划，或者查询性能低下。

**优化策略**：
重新梳理了数据模型，制定了明确的索引规范：
- **Users 表**：`_openid` 设为 **唯一索引 (Unique)**，确保单用户单账户。
- **Plans/Meditations 表**：`_openid` 设为 **非唯一索引**。这看似简单，却是支持“一对多”业务逻辑（一个用户多个计划）的关键。

---

## 🏗️ 第二部分：架构优势（为什么选择 Serverless？）

### 1. 极致的成本控制与零运维
对于独立开发者而言，购买 ECS 服务器和 RDS 数据库是一笔不小的开销。本项目全面采用**微信云开发 (Tencent CloudBase)**：
- **成本**：利用按量付费机制，开发阶段和初期运营成本几乎为 **0**。
- **鉴权**：后端服务直接在微信内网环境运行，无需处理复杂的 HTTPS 证书，也无需维护服务器安全补丁。

### 2. “离线优先”的数据同步策略
为了保证用户在弱网环境下的体验，我设计了一套**双层存储架构**：
- **Layer 1 (Local)**：用户创建计划、打卡记录优先写入 `uni.setStorageSync`，保证 UI 毫秒级响应。
- **Layer 2 (Cloud)**：后台异步发起云端同步请求。
- **容错机制**：如果云端同步失败（如断网），系统仅记录日志而不阻塞用户操作，待下次启动时再次尝试同步。

### 3. 数据安全与权限隔离
- **密钥安全**：`AppSecret` 严格保存在云函数环境变量中，前端仅通过临时的 `code` 交换 Token，彻底杜绝了前端反编译导致的密钥泄露风险。
- **行级安全 (RLS)**：数据库权限配置为“仅创建者可读写”，从底层引擎上物理隔离了不同用户的数据。

---

## ✨ 第三部分：项目核心亮点

### 1. AI 非结构化数据的“结构化”引擎
这不只是一个调用 API 的壳。项目内置了一套复杂的 **Plan Parser (解析器)**：
- **输入**：DeepSeek 模型生成的 Markdown 格式自然语言文本。
- **处理**：正则匹配与语义分析。
- **输出**：可被前端渲染的 JSON 对象（包含日期映射、任务分点、完成状态）。
这实现了从“感性的对话”到“理性的日程表”的自动转化。

### 2. 闭环的消息触达体系
利用云开发的**定时触发器 (Cron Job)**，系统每天早上 09:00 会自动唤醒：
1.  扫描所有 `status: active` 且开启了提醒的计划。
2.  校验用户的订阅消息授权状态。
3.  调用 `openapi.subscribeMessage.send` 下发提醒。
整个过程无需人工干预，形成了“授权 -> 计划 -> 提醒 -> 唤醒”的完整闭环。

### 3. 平滑的身份过渡体验
针对微信最新的隐私规范，项目抛弃了旧版 `getUserProfile`，全面适配了头像昵称填写能力（`chooseAvatar`）。同时，支持“游客模式”，允许未登录用户体验核心功能，待其产生沉没成本（如创建了第一个计划）后，再引导进行无感的一键登录与数据合并。

---

## 📝 总结

"自升" 项目证明了 **uni-app + 微信云开发 + AI API** 是目前独立开发者构建全栈应用的最佳实践之一。它不仅解决了跨端开发效率问题，更通过 Serverless 架构解决了后端运维的后顾之忧，让开发者能够专注于核心业务逻辑与 AI 交互体验的打磨。

---
*本文基于项目真实开发文档整理，转载请注明出处。*