name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œ ESLint
        run: npm run lint
        continue-on-error: false

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: npx tsc --noEmit
        continue-on-error: false

      - name: ç”Ÿæˆ Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}

      - name: éƒ¨ç½²åˆ° Vercel ç”Ÿäº§ç¯å¢ƒ
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --yes'

      - name: æ‰§è¡Œæ•°æ®åº“è¿ç§»
        if: success()
        run: |
          echo "ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          sleep 10
          curl -X POST https://www.clczl.asia/api/admin/migrate-category-field || echo "è¿ç§» API è°ƒç”¨å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
        continue-on-error: true

      - name: æ‰§è¡Œåšå®¢æ–‡ç« è¿ç§»
        if: success()
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œåšå®¢æ–‡ç« è¿ç§»..."
          sleep 5
          response=$(curl -s -X POST https://www.clczl.asia/api/admin/migrate-posts)
          echo "è¿ç§»å“åº”: $response"
          
          # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å« success
          if echo "$response" | grep -q '"success":true'; then
            echo "âœ… åšå®¢æ–‡ç« è¿ç§»æˆåŠŸ"
            echo "$response" | jq '.' || echo "$response"
          else
            echo "âš ï¸ åšå®¢æ–‡ç« è¿ç§»å¯èƒ½å¤±è´¥æˆ–éƒ¨åˆ†å¤±è´¥"
            echo "$response" | jq '.' || echo "$response"
            # ä¸é€€å‡ºï¼Œå› ä¸ºå¯èƒ½æ˜¯éƒ¨åˆ†æˆåŠŸ
          fi
        continue-on-error: true

      - name: å¥åº·æ£€æŸ¥
        if: success()
        run: |
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" https://www.clczl.asia || echo "000")
          if [ "$response" != "200" ]; then
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $response"
            exit 1
          else
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
          fi
        continue-on-error: true

      - name: å‘é€ Slack é€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² ${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}
            
            ğŸ“¦ åˆ†æ”¯: ${{ github.ref }}
            ğŸ“ æäº¤: ${{ github.sha }}
            ğŸ‘¤ æäº¤è€…: ${{ github.actor }}
            ğŸ”— éƒ¨ç½²é“¾æ¥: ${{ steps.vercel-deploy.outputs.preview-url || 'N/A' }}
            
            ${{ job.status == 'success' && 'âœ… éƒ¨ç½²å·²å®Œæˆï¼Œç½‘ç«™å·²æ›´æ–°' || 'âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—' }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: å‘é€é’‰é’‰é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: always() && secrets.DINGTALK_WEBHOOK_URL != ''
        run: |
          STATUS="${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}"
          EMOJI="${{ job.status == 'success' && 'âœ…' || 'âŒ' }}"
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"title\": \"ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€šçŸ¥\",
                \"text\": \"## ${EMOJI} ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²${STATUS}\n\n**åˆ†æ”¯:** ${{ github.ref }}\n\n**æäº¤:** \`${{ github.sha }}\`\n\n**æäº¤è€…:** ${{ github.actor }}\n\n**æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')\n\n**çŠ¶æ€:** ${STATUS}\"
              }
            }"
        continue-on-error: true

